---
import Layout from "../../layouts/Layout.astro";
import { LoginForm } from "../../components/auth/LoginForm";
import { AuthFormLayout } from "../../components/auth/AuthFormLayout";
import { getSupabaseServerClient } from "../../db/supabase";


// Set to SSR mode to ensure it's always rendered on the server
export const prerender = false;

// Check if user is already logged in

const supabase = getSupabaseServerClient(Astro.cookies, Astro.request);



const { data: { session } } = await supabase.auth.getSession();

// If user is logged in, redirect to dashboard or the specified redirectTo
if (session) {
  const redirectTo = Astro.url.searchParams.get('redirectTo') || '/dashboard';
  return Astro.redirect(redirectTo);
}

// Get any error from previous login attempts
const error = Astro.url.searchParams.get('error');
---

<Layout title="Sign In">
  <main class="flex flex-col items-center justify-center min-h-screen py-12 bg-background">
    <!-- Use client:only to ensure the AuthProvider only runs on the client side -->
      <AuthFormLayout 
        title="Sign In" 
        description="Enter your credentials to access your account"
      >
        <LoginForm 
          initialError={error || ""}
        />
      </AuthFormLayout>
  </main>
</Layout>

<script>
  console.log("Login page loaded - direct Astro script");
</script> 