import { getSupabaseServerClient } from '../../db/supabase';

export const prerender = false;

// Get the code from the URL
const code = Astro.url.searchParams.get('code');
const next = Astro.url.searchParams.get('next') || '/';

// Only process if code is present
if (code) {
  const supabase = getSupabaseServerClient(Astro.cookies, Astro.request);
  const { data, error } = await supabase.auth.exchangeCodeForSession(code);
  
  if (error) {
    console.error('Auth error:', error.message);
  } 
  
  if (data?.session) {
    // Set auth cookies
    Astro.cookies.set('sb-access-token', data.session.access_token, {
      path: '/',
      sameSite: 'lax',
      secure: import.meta.env.PROD,
      httpOnly: true
    });
    
    Astro.cookies.set('sb-refresh-token', data.session.refresh_token, {
      path: '/',
      sameSite: 'lax',
      secure: import.meta.env.PROD,
      httpOnly: true
    });
  }
}

// Always redirect after processing
return Astro.redirect(next); 